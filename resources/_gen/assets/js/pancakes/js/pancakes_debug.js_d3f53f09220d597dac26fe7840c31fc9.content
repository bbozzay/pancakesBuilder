const body=document.querySelector('body');const _=(el)=>{return document.querySelector(el);};const db=localStorage;let mainP=document.querySelector('main');window.addEventListener("load",(e)=>{let pageId=window.location;let savedData=`${pageId}.savedData`;AOS.init();if(typeof db.getItem(savedData)!=='undefined'&&db.getItem(savedData)!==null&&db.getItem(savedData)!==""){mainP.innerHTML=db.getItem(savedData);pancakes(pageId);}else{pancakes(pageId);};document.querySelector(".pb-close").addEventListener("click",(e)=>{body.classList.toggle("inspect-mode");console.log("clicked close");});});function pancakes(pageId){console.log("loading pancakes..."+pageId);const sectionClasses={padding_top:{xxl:"padding-xxl-top",xl:"padding-xl-top",l:"padding-l-top",m:"padding-m-top",s:"padding-s-top",xs:"padding-xs-top",xxs:"padding-xxs-top"},padding_bottom:{xxl:"padding-xxl-bottom",xl:"padding-xl-bottom",l:"padding-l-bottom",m:"padding-m-bottom",s:"padding-s-bottom",xs:"padding-xs-bottom",xxs:"padding-xxs-bottom"},margin_top:{xxl:"margin-xxl-top",xl:"margin-xl-top",l:"margin-l-top",m:"margin-m-top",s:"margin-s-top",xs:"margin-xs-top",xxs:"margin-xxs-top"},margin_bottom:{xxl:"margin-xxl-bottom",xl:"margin-xl-bottom",l:"margin-l-bottom",m:"margin-m-bottom",s:"margin-s-bottom",xs:"margin-xs-bottom",xxs:"margin-xxs-bottom"},margin_bottom:{xxl:"margin-xxl-bottom",xl:"margin-xl-bottom",l:"margin-l-bottom",m:"margin-m-bottom",s:"margin-s-bottom",xs:"margin-xs-bottom",xxs:"margin-xxs-bottom"},h_content:{start:"h_c_start",center:"h_c_center",end:"h_c_end",space_between:"h_c_space-between",space_around:"h_c_space-around"},v_content:{start:"v_c_start",center:"v_c_center",end:"v_c_end",space_between:"v_c_space-between",space_around:"v_c_space-around"},maxwidth:{xxl:"maxwidth-xxl",xl:"maxwidth-xl",l:"maxwidth-l",m:"maxwidth-m",s:"maxwidth-s",xs:"maxwidth-xs",xxs:"maxwidth-xxs"}}
const rowClasses={container:{fullwidth:"Full",container:"container",container_large:"Large"},h_content:{start:"h_c_start",center:"h_c_center",end:"h_c_end",space_between:"h_c_space-between",space_around:"h_c_space-around"},v_content:{start:"v_c_start",center:"v_c_center",end:"v_c_end",space_between:"v_c_space-between",space_around:"v_c_space-around"}}
const columnClasses={size:{"12":"col-12","11":"col-11","10":"col-10","9":"col-9","8":"col-8","7":"col-7","6":"col-6","5":"col-5","4":"col-4","3":"col-3","2":"col-2","1":"col-1"},h_content:{start:"h_c_start",center:"h_c_center",end:"h_c_end",space_between:"h_c_space-between",space_around:"h_c_space-around"},v_content:{start:"v_c_start",center:"v_c_center",end:"v_c_end",space_between:"v_c_space-between",space_around:"v_c_space-around"}}
const elementClasses={h_content:{start:"h_c_start",center:"h_c_center",end:"h_c_end",space_between:"h_c_space-between",space_around:"h_c_space-around"},v_content:{start:"v_c_start",center:"v_c_center",end:"v_c_end",space_between:"v_c_space-between",space_around:"v_c_space-around"}}
const exportYML=document.querySelector('.pb-export__yml');const mediaUploadButton=document.querySelector(".imageUpload");const pagesDrawer=document.querySelector(".pb-pagesContainer");const pagesBtn=document.querySelector(".pb-pageNavigator");const mediaBox=document.querySelector(".mediaUploads");let savedData=`${pageId}.savedData`;let saveChangesButton=document.querySelector(".pb-quickBtns .pb-saveChanges");let revertChangesButton=document.querySelector(".pb-quickBtns .pb-revertChanges");let clearChangesButton=document.querySelector(".pb-quickBtns .pb-clearChanges");let debugBarMenuTitle=document.querySelector(".debugging-bar .pb-dynamicArea .debugBarMenuTitle");let debugBarSubMenu=document.querySelector(".debugging-bar .pb-dynamicArea > ul");const makeEditable=()=>{let editElements=document.querySelectorAll('[data-edit]');console.log("makeeditable");let toArr=Array.prototype.slice.call(editElements);Array.prototype.forEach.call(toArr,(obj,index)=>{obj.addEventListener('dblclick',(e)=>{console.log("edit this element");console.log(obj);if(obj.getAttribute('data-element')=="element-image"){console.log("it's an image");let imageSrc=obj.getAttribute('src');let imageSrcset=obj.getAttribute('srcset');html=`<input type="text" value="${imageSrc}"></input>
            <input id="submit" type="submit"></input>`;createDynamicContent(html);_(".pb-populateValues input[type='submit']").addEventListener("click",(e)=>{console.log("submit");imageSrc=_(".pb-populateValues input[type='text']").value;obj.setAttribute('src',imageSrc);obj.setAttribute('srcset','');obj.setAttribute('data-srcset','');});}else if(obj.getAttribute('data-element')=="element-title"){let titleTag=obj.tagName;let titleText=obj.innerText;html=`
            <input type="text" data-attr-text="title-text" value="${titleText}"></input>
            <input type="text" data-attr-tag="title-tag" value="${titleTag}"></input>
            <input id="submit" type="submit"></input>`;createDynamicContent(html);_(".pb-populateValues input[type='submit']").addEventListener("click",(e)=>{console.log("submit");titleText=_(".pb-populateValues input[data-attr-text='title-text']").value;titleTag=_(".pb-populateValues input[data-attr-tag='title-tag']").value;let newTitle=document.createElement(titleTag);newTitle.setAttribute("id","seven");let oldAttrs=obj.attributes;Array.from(oldAttrs).forEach(function(item,key){console.log("oldattrs");console.log(item);console.log(key);newTitle.setAttribute(item.name,item.value);});console.log(newTitle);console.log(obj.attributes);newTitle.innerText=titleText;console.log(obj.parentNode.replaceChild(newTitle,obj));sanitizeItems();});}else{html=obj;createDynamicDialogue(obj,html);}});});};function createDynamicDialogue(obj,html){console.log(html);let dDialogue=_(".pb-dynamicDialogue");dDialogue.classList.add("active");let objNew=dDialogue.querySelector("textarea").value=html.innerHTML;dDialogue.querySelector("input[type='submit']").addEventListener("click",(e)=>{dDialogue.classList.remove("active");objNew=dDialogue.querySelector("textarea").value;obj.innerHTML=objNew;});}
function onChange(){console.log("something changed...");}
saveChangesButton.addEventListener("click",()=>{db.setItem(savedData,mainP.innerHTML);});revertChangesButton.addEventListener("click",()=>{revertChanges();});clearChangesButton.addEventListener("click",()=>{undo();});function revertChanges(){if(typeof db.getItem(savedData)!=='undefined'&&db.getItem(savedData)!=='undefined'&&db.getItem(savedData)!=='null'&&db.getItem(savedData)!=null&&db.getItem(savedData)!==""){mainP.innerHTML=db.getItem(savedData);sanitizeItems();};}
function undo(){if(typeof db.getItem(savedData)!=='undefined'&&db.getItem(savedData)!=='undefined'&&db.getItem(savedData)!=='null'&&db.getItem(savedData)!=null){db.setItem(savedData,"");sanitizeItems();};}
function initOverlays(){}
mediaUploadButton.addEventListener("click",()=>{mediaBox.classList.toggle("active");mediaUploadButton.classList.toggle("active");});let sections=document.querySelectorAll('section');pagesBtn.addEventListener("click",()=>{pagesDrawer.classList.toggle("active");});sanitizeItems();function sanitizeItems(){console.log("sanitizeItems...");document.querySelectorAll(".dbg-each-menu").forEach(e=>e.parentNode.removeChild(e));formSections(sectionClasses);makeEditable();}
function createEditMenu(selectedItem,selectedTitle,selectedType,index){let debugWidget=`<span id="section-dbg-menu" class="dbg-each-menu">
    
    <div class="dbg-main-btns">
    
    <i class="fas fa-arrows-alt"></i>
    <span class="this-selected-name">${selectedTitle}</span>
    <a class="prepend-me part-edit" title="Open the Page Editor for this Part" href="https://app.forestry.io/sites/site_id/#/pages/content-{{ $.Scratch.Get "part_preview_link" }}"><i class="fas fa-external-link-alt"></i></a>
    <i class="fas fa-pen-square"></i>
    </div>
    </span><!--dbg-each-menu-->`;selectedItem.innerHTML=selectedItem.innerHTML+debugWidget;selectedItem.addEventListener("mouseenter",(e)=>{selectedItem.classList.toggle("hovered");});selectedItem.addEventListener("mouseleave",(e)=>{selectedItem.classList.toggle("hovered");});let debugMenuEditBtn=selectedItem.querySelector("#section-dbg-menu .fa-pen-square");debugMenuEditBtn.addEventListener("click",(e)=>{document.querySelector(".debugging-bar .pb-dynamicArea").classList.toggle("active");defineClasses(selectedItem,selectedTitle,selectedType,sectionClasses);});}
function defineClasses(selectedItem,selectedTitle,selectedType,sectionClasses,index){let selectedClasses="";let html="";if(selectedType=="section"){selectedClasses=sectionClasses;}else if(selectedType=="row"){selectedClasses=rowClasses;}else if(selectedType=="column"){selectedClasses=columnClasses;}
debugBarSubMenu.innerHTML="";debugBarMenuTitle.innerText="";debugBarMenuTitle.innerText=selectedType;for(const par in selectedClasses){debugBarSubMenu.innerHTML+=`<li data="${par}"><strong>${par}</strong> </li>`;for(const pat in selectedClasses[par]){if(selectedItem.classList.contains(selectedClasses[par][pat])){debugBarSubMenu.innerHTML+=`<li data-parent="${par}" data="${selectedClasses[par][pat]}" class="active">${pat}</li>`;}else{debugBarSubMenu.innerHTML+=`<li data-parent="${par}" data="${selectedClasses[par][pat]}">${pat}</li>`;}}}
let dataVals=debugBarSubMenu.querySelectorAll("li[data]");dataVals.forEach(function(dataVal,index){let dataValAttr=dataVal.getAttribute("data");let pParent=dataVal.getAttribute("data-parent");dataVal.addEventListener("click",(e)=>{let pVal=e.currentTarget.getAttribute("data");let thisDataParent=e.currentTarget.getAttribute("data-parent");for(const pat in selectedClasses[pParent]){if(selectedClasses[pParent][pat]===pVal){}else{selectedItem.classList.remove(selectedClasses[pParent][pat]);}}
selectedItem.classList.remove(pVal);selectedItem.classList.add(pVal);let dataVs=debugBarSubMenu.querySelectorAll("li[data]");let thDt=debugBarSubMenu.querySelectorAll("li[data-parent*='"+pParent+"']");thDt.forEach(function(thDts,index){if(thDts.classList.contains("active")){thDts.classList.remove("active");}
dataVal.classList.add("active");});dataVal.classList.add("active");});});if(!_(".debugging-bar .pb-dynamicArea").classList.contains("active")){_(".debugging-bar .pb-dynamicArea").classList.add("active");}}
function formSections(sectionClasses){console.log("formSections...");sections.forEach(function(section,index){let selectedTitle=section.getAttribute('template');let selectedItem=section;let selectedType=section.getAttribute('selected-type');createEditMenu(selectedItem,selectedTitle,selectedType,sectionClasses);section.setAttribute('data-highlightable','1');let rows=section.querySelectorAll('#row');let dbgSelectedTitle=document.querySelector(".debugging-bar .pb-dynamicArea > li");section.addEventListener("click",(e)=>{let activeSection=document.querySelector('section.sticky');dbgSelectedTitle.innerHTML=`<li>${selectedTitle}</li>`;});rows.forEach(function(row,index){let selectedTitle=row.getAttribute('template');let selectedItem=row;let selectedType=row.getAttribute('selected-type');createEditMenu(selectedItem,selectedTitle,selectedType);let columns=row.querySelectorAll('div[size]');row.setAttribute('data-highlightable','1');columns.forEach(function(column,index){let selectedTitle=column.getAttribute('size');let selectedItem=column;let selectedType=column.getAttribute('selected-type');createEditMenu(selectedItem,selectedTitle,selectedType);column.setAttribute('data-highlightable','1');column.addEventListener("mouseenter",()=>{column.classList.add("active");let colName=column.className.split(' ').some(c=>/col-.*/.test(c));if(column.className.split(' ').some(c=>/col-.*/.test(c))){}else{}});column.addEventListener("mouseleave",()=>{column.style="";});let elements=column.querySelectorAll('.elements-wrapper');elements.forEach(function(element,index){element.setAttribute('data-highlightable','1');});});});});dragDrop();}
let exportBox=document.querySelector(".exportYMLbox");exportYML.addEventListener("click",()=>{console.log("start export");createExportYml();exportYML.classList.toggle("active");exportBox.classList.toggle("active");});const getTpl=(element)=>{return tpl[element];};debugBarMenuTitle.addEventListener("click",()=>{debugBarMenuTitle.classList.toggle("active");});if(_(".pb-dynamicArea").classList.contains("active")){dragulaCreate();}else{_(".debugging-bar .pb-addItems").addEventListener("click",()=>{html=_(".pb-dragSourceList").innerHTML;createDynamicContent(html);dragDrop();});}
function dragDrop(){console.log("dragDrop...");dragula([_("main")],{moves:function(el,container,handle){return handle.classList.contains('fa-arrows-alt');},invalid(el,handle){return(el.classList.contains("row")||el.classList.contains("column"));}}).on('out',function(el){el.classList.remove("in-transit");AOS.refresh();});let containers=[].slice.call(document.querySelectorAll("section"));dragula(containers,{moves:function(el,container,handle){return handle.classList.contains('fa-arrows-alt');},invalid(el,handle){return(el.classList.contains("column")||el.classList.contains("element"));}}).on('drag',function(el){el.classList.add("in-transit");}).on('out',function(el){el.classList.remove("in-transit");AOS.refresh();});containers=[].slice.call(document.querySelectorAll(".row"));dragula(containers,{moves:function(el,container,handle){return handle.classList.contains('fa-arrows-alt');},direction:'horizontal',invalid(el,handle){return(el.classList.contains("element"));}}).on('out',function(el){el.classList.remove("in-transit");AOS.refresh();});;let dragMenu=document.querySelector(".debugging-bar .pb-dynamicArea .pb-populateValues ul.elementsDrag");containers=Array.prototype.slice.call(document.querySelectorAll("section .row .column .elements-wrapper")).concat(dragMenu);let elementDrake=dragula({containers,direction:'vertical',revertOnSpill:true,removeOnSpill:false,ignoreInputTextSelection:true,copy(el,source){return source===dragMenu;},accepts(el,target,source){if(target.classList.contains("elements-wrapper")){return target!==dragMenu;}},});elementDrake.on('drop',function(el,container){if(container.classList.contains("elements-wrapper")&&el.getAttribute('data-tpl')){itemCreate(el)}
if(container==dragMenu){el.innerHTML=el.getAttribute('data-title');}});let rowDragMenu=document.querySelector(".debugging-bar .pb-dynamicArea .pb-populateValues ul.rowsDrag");containers=Array.prototype.slice.call(document.querySelectorAll(".row")).concat(rowDragMenu);let rowDrake=dragula({containers,direction:'horizontal',revertOnSpill:true,removeOnSpill:false,ignoreInputTextSelection:true,moves(el,source){console.log("el");console.log(el);return source===rowDragMenu;},copy(el,source){return source===rowDragMenu;},accepts(el,target,source){if(target.classList.contains("row")){return target!==rowDragMenu;}},invalid(el,handle){return(el.classList.contains("elements-wrapper"));}});rowDrake.on('drop',function(el,container){if(container.classList.contains("row")&&el.getAttribute('data-tpl')){itemCreate(el);}
if(container==rowDragMenu){el.innerHTML=el.getAttribute('data-title');}});function itemCreate(el){let elReplace=el.querySelector(".element-content").innerHTML;elReplace=document.createRange().createContextualFragment(elReplace);console.log(elReplace);console.log(el.parentNode.querySelector("li[data-tpl]"));el.parentNode.replaceChild(elReplace,el);sanitizeItems();}}
function createDynamicContent(html,index){console.log("createDynamicContent in the sidebar...");_(".pb-dynamicArea .pb-populateValues").innerHTML=html;if(html){_(".debugging-bar .pb-dynamicArea").classList.add("active");}else{_(".debugging-bar .pb-dynamicArea").classList.remove("active");}}
function createExportYml(index){let exportBox=document.querySelector(".exportYMLbox");let sections=document.querySelectorAll('section');let formattedParams="stacks:\n";let indentParams="";sections.forEach(function(section,index){let selectedTitle=section.getAttribute('template');formattedParams+=`- template: ${selectedTitle}\n`;indentParams="  ";selectedClasses=sectionClasses;for(const par in selectedClasses){for(const pat in selectedClasses[par]){if(section.classList.contains(selectedClasses[par][pat])){formattedParams+=`${indentParams}${par}: ${pat}\n`;}}}
let rows=section.querySelectorAll('#row');formattedParams+=`${indentParams}rows:\n`;rows.forEach(function(row,index){selectedTitle=row.getAttribute('template');formattedParams+=`  - template: include-row\n`;indentParams="    ";selectedClasses=rowClasses;for(const par in selectedClasses){for(const pat in selectedClasses[par]){if(row.classList.contains(selectedClasses[par][pat])){formattedParams+=`${indentParams}${par}: ${pat}\n`;}}}
let columns=row.querySelectorAll(".column");formattedParams+=`${indentParams}cols:\n`;columns.forEach(function(column,index){selectedTitle=column.getAttribute('template');indentParams="    ";formattedParams+=`${indentParams}- template: block-column-builder\n`;indentParams="      ";selectedClasses=columnClasses;for(const par in selectedClasses){for(const pat in selectedClasses[par]){if(column.classList.contains(selectedClasses[par][pat])){formattedParams+=`${indentParams}${par}: ${pat}\n`;}}}
const elements=column.querySelectorAll('.elements-wrapper');formattedParams+=`${indentParams}elements:\n`;elements.forEach(function(element,index){formattedParams+=`${indentParams}- template: element-title\n`;indentParams="        ";selectedClasses=elementClasses;for(const par in selectedClasses){for(const pat in selectedClasses[par]){if(element.classList.contains(selectedClasses[par][pat])){formattedParams+=`${indentParams}${par}: ${pat}\n`;}}}});});});});console.log(formattedParams);exportBox.value=formattedParams;}}